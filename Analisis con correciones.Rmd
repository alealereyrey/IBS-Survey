---
title: "Encuesta SII"
author: "Ale"
date: "2 de septiembre de 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Cargo todas las librerías que voy a usar

```{r echo=TRUE, results='hide'}
library(tidyverse)
library(dplyr)
library(gapminder)
library(readxl)
library(qdapTools)
library(janitor)
library(kableExtra)
library(extrafont)
library(table1)
```


## Cargo las bases de datos y evalúo como estan nombradas las columnas

```{r}
encuesta <- read.csv("C:/Users/Ale/Desktop/Encuesta SII soifer/SII en Argentina.csv", fileEncoding = "UTF-8", na.strings="")
                       
```

## Indico que la separación por decimales sea con , 
```{r}
options(OutDec= ",")
```

## Renombro las columnas (preguntas)

```{r}

names(encuesta) <- c("Fecha", "DNI", "Edad", "Genero","Provincia de residencia", "Ciudad donde ejerce", "Orientación prioritaria","Lugar de Trabajo", "SII mensual", "Criterio diagnóstico SII", "¿Existe SII sin dolor?", "Variante más frecuente", "Variantes que puede pasar por alto una patología orgánica", "Fisiopatología más frecuente variante diarrea", "Fisiopatología más frecuente variante constipación", "Variantes con más psico-comorbilidad", "Variantes con menos alternativas terapéuticas", "Loperamida", "Carbón", "Bismuto", "Rifaximina", "Otros ATB", "Probióticos", "Trimebutina", "Trimebutina/simeticona", "Alverina/simeticona", "Pinaverio", "Otilonio", "Colestiramina", "Amitriptilina", "Antiespasmódicos ansiolíticos", "Dieta", "Polietilenglicol", "Psyllium", "Lactulosa", "Linaclotida", "Prucalopride", "Sales biliares", "Trimebutina constipacion", "Bisacodilo/picosulfato", "Antibióticos constipacion", "Senósidos", "Dieta constipacion", "¿Considera primero evitar medicación y emplear dieta y productos naturales?", "Indicación de antidepresivos", "Utiliza terapias alternativas en el SII", "Meta principal endel tratamiento del SII", "Nivel de frustración", "Tratamiento más complejo en género", "¿Le desagrada que el paciente concurra con información de internet y discuta con ud?", "¿Qué perfil/es de personalidad de su paciente le resula más dificil abordar?", "¿Preferiría de ser posible dejar de atender este tipo de pacientes?", "Con respecto a los estudios previos del paciente", "¿Cuánto tiempo le demanda el paciente funcional en relación a otras patologías¿", "En caso que considere que le lleva más tiempo, ¿Eso lo incomoda?", "Considera que estuchar al paciente:", "¿Qué tipo de escucha realiza?", "En caso de considerar que su escucha es insuficiente, esto se debe a:", "¿Cuánto tiempo le dedica a la primera consulta?", "Considera que la educación que se le brinda a los pacientes:", "¿Cuánto del tratamiento considera que depende del paciente?", "¿Cree que los pacientes con SII se preocupan demasiado por su trastorno?", "¿Cree que los pacientes con SII consultan principalmente por miedo a padecer cáncer?", "¿Considera que el componente psicológico en estos pacientes es más importante que el biológico?", "¿Considera que estos pacientes deben ser derivados a una terapia psicológica?", "Trabaja ud. en equipo con:", "¿Cuál es su vía de comunicación preferente con su paciente?", "¿Pregunta sobre la posibilidad de abusos como disparadores de la sintomatología?", "Si la respuesta es afirmativa, ¿Lo interroga en la primera consulta?", "¿Pregunta de la misma manera sobre abuso si el paciente es hombre o mujer?", "¿Cuán satisfecho se encuentra con su práctica clínica en el paciente con SII?", "¿Qué otras condiciones siente que necesitaría para optimizarla?")


```

##Exploración de missing values

```{r}
# Definir una funcion que cuente los NaNs y aplicarla al dataframe

na_count <- sapply(encuesta, function(y) sum(length(which(is.na(y)))))


#Creo un dataframe con los valores nulos

na_count <- data.frame(na_count)
na_count

```


## Limpieza

Una de las observaciones que dice hombre;mujer, la renombro hombre. 
Limpio iterando sobre unique
Limpio los medicamentos que tienen mas de una opcion

Agrego columnas:
-Edad ordinalizada
-Region de residencia
-Orientación dicotómica

```{r}
encuesta$Genero[181] <- "Hombre"

unique(encuesta$`Ciudad donde ejerce`)

encuesta <- encuesta %>%
                mutate(`Provincia de residencia` = case_when(str_detect(`Provincia de residencia`, regex("caba|C.A.B.A|ciudad|capital|a(i|u)res|bs as", ignore_case = T)) ~"Buenos Aires", 
                                                             str_detect(`Provincia de residencia`, regex("c(o|ó)rdoba", ignore_case = T)) ~ "Córdoba",
                                                             str_detect(`Provincia de residencia`, regex("chubut", ignore_case = T)) ~ "Chubut",
                                                             str_detect(`Provincia de residencia`, regex("entre r(i|í)os", ignore_case = T)) ~ "Entre Ríos",
                                                             str_detect(`Provincia de residencia`, regex("negro", ignore_case = T)) ~ "Río Negro",
                                                             str_detect(`Provincia de residencia`, regex("neuqu(e|é)n", ignore_case = T)) ~ "Neuquén",
                                                             str_detect(`Provincia de residencia`, regex("chac", ignore_case = T)) ~ "Chaco",
                                                             str_detect(`Provincia de residencia`, regex("tuc", ignore_case = T)) ~ "Tucumán",
                                                             str_detect(`Provincia de residencia`, regex("salta", ignore_case = T)) ~ "Salta",
                                                             str_detect(`Provincia de residencia`, regex("mendoza", ignore_case = T)) ~ "Mendoza",
                                                              str_detect(`Provincia de residencia`, regex("Formosa", ignore_case = T)) ~ "Formosa",
                                                              str_detect(`Provincia de residencia`, regex("rioja", ignore_case = T)) ~ "La Rioja",
                                                              str_detect(`Provincia de residencia`, regex("santiago del estero", ignore_case = T)) ~ "Santiago del Estero",
                                                             str_detect(`Provincia de residencia`, regex("santa fe|sta fe|sfe", ignore_case = T)) ~ "Santa Fe", T ~ `Provincia de residencia`),
                       `Ciudad donde ejerce`= case_when(str_detect(`Ciudad donde ejerce`, regex("mar del plata", ignore_case = T)) ~ "Mar del plata",
                                                        str_detect(`Ciudad donde ejerce`, regex("resistencia", ignore_case = T)) ~ "Resistencia",
                                                        str_detect(`Ciudad donde ejerce`, regex("mendoza", ignore_case = T)) ~ "Mendoza",
                                                        str_detect(`Ciudad donde ejerce`, regex("salta", ignore_case = T)) ~ "Salta",
                                                        str_detect(`Ciudad donde ejerce`, regex("rosario", ignore_case = T)) ~ "Rosario",
                                                        str_detect(`Ciudad donde ejerce`, regex("c(o|ó)rdoba", ignore_case = T)) ~ "Córdoba",
                                                        str_detect(`Ciudad donde ejerce`, regex("Peña", ignore_case = T)) ~ "PR Saenz Peña",
                                                        str_detect(`Ciudad donde ejerce`, regex("General Roca", ignore_case = T)) ~ "Gral Roca",
                                                        str_detect(`Ciudad donde ejerce`, regex("Pico", ignore_case = T)) ~ "Gral Pico",
                                                        str_detect(`Ciudad donde ejerce`, regex("Paran(a|á)", ignore_case = T)) ~ "Paraná",
                                                        str_detect(`Ciudad donde ejerce`, regex("tucuman|SMT", ignore_case = T)) ~ "SM Tucuman",
                                                        str_detect(`Ciudad donde ejerce`, regex("C.A.B.A.|CABA|Buenos|bs as|capital federal|capital$|Morón|Pilar|Lujan|La plata|Varela|Mejía|Quilmes|Palomar|Isidro|Vicente|cas$|Zamora|Campana|argentina", ignore_case = T)) & `Provincia de residencia` == "Buenos Aires"  ~ "AMBA",
                                                   T ~ `Ciudad donde ejerce`),
                       `Fisiopatología más frecuente variante diarrea` = case_when(str_detect(`Fisiopatología más frecuente variante diarrea`,regex("medicamentos")) ~ "Medicamentos",
                                                                           str_detect(`Fisiopatología más frecuente variante diarrea`,regex("Disbiosis")) ~ "Disbiosis/sobrecrecimiento", T ~`Fisiopatología más frecuente variante diarrea`),
                       Edad_ordinal = cut(Edad, 3, labels=c("< 40","41-65"," > 65")),
                       `Región de residencia` = case_when(`Provincia de residencia` %in% c("Salta", "Jujuy", "Santiago del Estero", "Catamarca", "Tucumán", "La Rioja") ~ "NOA", 
                                                  `Provincia de residencia` %in% c("Formosa", "Chaco", "Misiones", "Corrientes") ~"NEA",
                                                  `Provincia de residencia` %in% c("La Pampa", "Río Negro", "Santa Cruz", "Chubut", "Neuquén") ~ "Patagonia", 
                                                  `Provincia de residencia` %in% c("Santa Fe", "Córdoba", "Entre Ríos", "Buenos Aires") ~"Centro",
                                                  `Provincia de residencia` %in% c("San Luis", "Mendoza") ~"Cuyo",
               T ~ `Provincia de residencia`),
               `Orientación dicotómica` = if_else(str_detect(`Orientación prioritaria`,regex("Motilidad")), "Neurogastro", "No neurogastro"
               )) %>%
        separate(., col = 18, into = "Loperamida", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 19, into = "Carbón", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 20, into = "Bismuto", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 21, into = "Rifaximina", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 22, into = "Otros antibióticos", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 23, into = "Probióticos", sep = ";", extra = "drop", fill = "right") %>%
        separate(., col = 24, into = "Trimebutina", sep = ";", extra = "drop", fill = "right") %>%
        separate(., col = 25, into = "Trimebutina/simeticona", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 26, into = "Alverina/simeticona", sep = ";", extra = "drop", fill = "right") %>%
        separate(., col = 27, into = "Pinaverio", sep = ";", extra = "drop", fill = "right") %>%
        separate(., col = 28, into = "Otilonio", sep = ";", extra = "drop", fill = "right") %>%
        separate(., col = 29, into = "Colestiramina", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 30, into = "Amitriptilina", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 31, into = "Antiespasmódicos", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 32, into = "Dieta", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 33, into = "Polietilenglicol", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 34, into = "Psyllium", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 35, into = "Lactulosa", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 36, into = "Linaclotida", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 37, into = "Prucalopride", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 38, into = "Sales biliares", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 39, into = "Trimebutina constipacion", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 40, into = "Bisacodilo/picosulfato", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 41, into = "Antibióticos constipacion", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 42, into = "Senósidos", sep = ";", extra = "drop", fill = "right")%>%
        separate(., col = 43, into = "Dieta constipacion", sep = ";", extra = "drop", fill = "right")

encuesta_trabajo <- mtabulate(strsplit(encuesta$`Lugar de Trabajo`, " y ")) %>%
        mutate(`Centro médico` = `centro médico privado` + `Centro médico privado` + `Céntro médico`,
               `Consultorio privado` = `Consultorio privado` + `consultorio médico privado` +`consultorio privado`) %>%
        select(c(`Centro médico`, `Consultorio privado`, Hospital)) 

encuesta <- cbind(encuesta, encuesta_trabajo)
```

## Factorizo la efectividad de los tratamientos

```{r}
cols <- c("Loperamida", "Carbón",  "Bismuto", "Rifaximina", "Otros antibióticos", "Probióticos", "Trimebutina", "Trimebutina/simeticona", "Alverina/simeticona", "Pinaverio", "Otilonio", "Colestiramina", "Amitriptilina", "Antiespasmódicos", "Dieta","Polietilenglicol","Psyllium", "Lactulosa", "Linaclotida", "Prucalopride", "Sales biliares" , "Trimebutina constipacion", "Bisacodilo/picosulfato", "Antibióticos constipacion", "Senósidos", "Dieta constipacion" )

encuesta[cols] <- lapply(encuesta[cols], tolower)
encuesta[cols] <- lapply(encuesta[cols], factor, levels = c("muy efectiva", "algo efectiva", "no efectiva", "no se"), ordered = T)
                      
```


## Calculo mínimos y máximos de edad de gastros y las medidas de distribución central y CI

```{r}

min(encuesta$Edad)
max(encuesta$Edad)
mean(encuesta$Edad)
median(encuesta$Edad)
Rmisc::CI(encuesta$Edad, ci = 0.95)

getmode <- function(x) {
   uniq <- unique(x)
   uniq[which.max(tabulate(match(x, uniq)))]
}

getmode(encuesta$Edad)
```

## Grafico pirámide poblacional
Para eso necesitamos transformar la edad en una variable ordinal
Luego paso el numero de especialistas a double para poder multiplicar los hombres por -1 para que quede como pirámide poblacional. 


```{r}

dfpiramide <- encuesta %>%
        mutate (Edad_ordinal = cut(Edad, 11, labels=c("26-30","31-35","36-40","41-45","46-50","51-55","56-60","61-65","66-70","71-75","76+")))%>%
                group_by(Edad_ordinal) %>%
        count(Genero, name = "especialistas")%>%
        ungroup

dfpiramide$especialistas <- as.double(dfpiramide$especialistas)

dfpiramide2 <- dfpiramide %>%
        mutate(especialistas = if_else(Genero == "Hombre", -1*especialistas, especialistas))


piramide <- ggplot(dfpiramide2, aes(x = Edad_ordinal, y = especialistas, fill = Genero)) + 
  geom_bar(stat = "identity") + 
                 coord_flip() + 
               scale_y_continuous(breaks = seq(-40, 40, by = 5), 
                     labels = c(rev(seq(0, 40, by = 5)), seq(5, 40, by = 5))) + 
  scale_fill_manual(values = c("cornflowerblue", "#E76BF3")) +
        labs(y = "N° de especialistas", x = "Edad", fill = "Género") 


+
        theme(text = element_text(family = "serif", size = 12),
              plot.title = element_text(family = "serif", size = 12, face = "bold"),
              plot.caption = element_text(hjust = 0, family = "serif", size = 12))

piramide

```

## Exporto piramide a word con paquete officer

```{r}
library(officer)
library(rvg)

ggsave("piramide.png", 
       piramide,
       width = 4,
       height = 3,
       units = "in"
       )

piramide_doc <- read_docx()

piramide_doc <- body_add_img(piramide_doc,
                             src= "piramide.png",
                             width = 4,
                             height = 3)


print(piramide_doc, target = "C:/Users/Ale/Desktop/Encuesta SII soifer/piramide_doc.docx")                       


doc <- read_pptx()
doc <- add_slide(doc, 'Title and Content', 'Office Theme')
# Add the plot
doc <- ph_with.dml(doc, ggobj = piramide, type = 'body')  
# Write the document to a file
print(doc, target = 'C:/Users/Ale/Desktop/Encuesta SII soifer/plot.pptx')


anyplot = dml(code = barplot(1:5, col = 2:6), bg = "wheat")

library(tidyverse)
library(rvg)
library(officer)
anyplot = dml(grafico_residencia)
doc <- read_pptx()
doc <- add_slide(doc, "Title and Content", "Office Theme")
doc <- ph_with(doc, anyplot, location = ph_location_fullsize())

print(doc, target = 'C:/Users/Ale/Desktop/Encuesta SII soifer/graficos para word/plot.pptx')
```

## Elaboro tabla 1 para descipción poblacional

```{r}

## hago un nuevo df para factorizar variables sin modificar el original

encuesta2<-encuesta

encuesta2$`Centro médico` <-
        factor(encuesta2$`Centro médico`, 
               levels = c(0,1),
               labels = c("Sí","No"))

encuesta2$`Consultorio privado` <-
        factor(encuesta2$`Consultorio privado`, 
               levels = c(0,1),
               labels = c("Sí","No"))

encuesta2$`Hospital` <-
        factor(encuesta2$`Hospital`, 
               levels = c(0,1),
               labels = c("Sí","No"))

## Creo una funcion para sacar media y proporción

my.render.cont <- function(x) {
    with(stats.apply.rounding(stats.default(x), digits=3, digits.pct = 1), c("",
        "Media (DS)"=sprintf("%s (&plusmn; %s)", MEAN , SD)))
}
my.render.cat <- function(x) { 
  sub('.', ',', c("", sapply(stats.default(x), 
  function(y) with(y, sprintf("%d (%0.2f %%)", FREQ, PCT)))), fixed = TRUE) 
}
 
       
##creo quna funcion para calcular la p

pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        p <- t.test(y ~ g)$p.value
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=1, eps=0.001)))
}


tabla1 <- table1( ~Edad + `Región de residencia` + `Orientación dicotómica` + `Centro médico` + `Consultorio privado` + `Hospital`|Genero, data=encuesta2, overall=F, render.missing=NULL, render.continuous=my.render.cont, render.categorical=my.render.cat, extra.col=list(`P-valor`=pvalue))


## version con especialidad en columna
tabla2 <- table1( ~Edad + `Región de residencia` + `Centro médico` + `Consultorio privado` + `Hospital`| `Orientación dicotómica`*Genero, data=encuesta2, overall= F, render.continuous=my.render.cont, render.categorical=my.render.cat)


tabla1
tabla2
```

## Exporto tabla 1 a word

```{r}

ggsave("tabla1.png", 
       tabla1,
       width = 4,
       height = 3,
       units = "in"
       )

tabla1_doc <- read_docx()

tabla1_doc <- body_add_img(tabla1_doc,
                             src= "tabla1.png",
                             width = 4,
                             height = 3)


print(piramide_doc, target = "C:/Users/Ale/Desktop/Encuesta SII soifer/graficos para word/tabla1_doc.docx") 
```

## Calculo la distribución geográfica de los especialistas según provincia
Veo que falta tidy. 

```{r}

head(encuesta)

distribucion_residencia <- encuesta%>%
                        na.omit(`Provincia de residencia`) %>%
                        group_by(Genero)%>%
                        count(`Provincia de residencia`, `Ciudad donde ejerce`, `Región de residencia`, name = "Especialistas") %>%
                        ungroup()


grafico_residencia <- ggplot(distribucion_residencia, aes(x = `Provincia de residencia`, y = Especialistas, fill = Genero)) +
                                     geom_bar(stat = "identity", position = "dodge", na.rm = T) +
                                coord_flip() + 
                   scale_y_continuous(breaks = seq(0, 90, by = 10)) +
                   labs(title = "Especialistas según provincia de residencia", subtitle = "Distribución según género") +
                           scale_fill_manual(values = c("cornflowerblue", "#E76BF3"))

grafico_residencia

```

```{r}
ciudad_buenos_aires <- distribucion_residencia %>%
                                filter(distribucion_residencia$`Provincia de residencia` %in% "Buenos Aires")

grafico_ciudad_buenos_aires <- ggplot(ciudad_buenos_aires,
                          aes(x = `Ciudad donde ejerce`, y = Especialistas, fill = `Ciudad donde ejerce`)) +
                        geom_bar(position = "dodge", stat = "identity") +
        labs(title = "Ciudad de ejercicio de la profesión", subtitle = "Residencia Provincia de Buenos Aires") +
                              theme_bw() +
        coord_flip()
        
                          
resto_del_pais <- distribucion_residencia %>%
                 filter(distribucion_residencia$`Provincia de residencia` != "Buenos Aires")


grafico_resto_del_pais<- ggplot(resto_del_pais,
                          aes(x = `Provincia de residencia`, y = Especialistas, fill = `Ciudad donde ejerce`)) +
                        geom_bar(position = "dodge", stat = "identity") +
                              theme_bw() +
                        coord_flip() 


                         labs(title = "Ciudad de ejercicio de la profesión", subtitle = "Residencia resto del país") +
                facet_wrap(~`Provincia de residencia`)

                         
                         
grafico_resto_del_pais                         
                         
                         
                         
grafico_ciudad_buenos_aires
```


```{r}

grafico_regiones<- ggplot(distribucion_residencia,
                          aes(x = `Provincia de residencia`, y = Especialistas, fill = `Provincia de residencia`)) +
                        geom_bar(position = "dodge", stat = "identity") +
                              theme_bw() +
        coord_flip() +
                     facet_wrap(~`Región de residencia`, scales="free", ncol = 2) +
        labs(title = "Especialistas según región de residencia", y="N° de especialistas")

grafico_regiones
```

## Grafico orientacion

```{r}

unique(encuesta$`Orientación prioritaria`)

## tabular la especialidad
tabla_orientacion <- mtabulate(strsplit(encuesta$`Orientación prioritaria`, ";")) %>%
                         summarise_all(.funs = sum,na.rm=T) %>%
                        pivot_longer(cols = 1:6, names_to = "Orientación", values_to = "Médicos") %>%
        mutate(`Orientación` = fct_reorder(`Orientación`,`Médicos`))

grafico_orientacion <- 
        ggplot(tabla_orientacion,
                             aes (x= `Orientación`, y = `Médicos`, fill = `Orientación`)) +
                         geom_col() + 
        theme(axis.text.y=element_blank()) +
                scale_fill_brewer(palette = "Accent")+ 
        coord_flip () +
        expand_limits(y = c(0,280)) +
        labs (title = "Orientación prioritaria en la especialidad",y = "N° de médicos") +
        geom_text(position = position_dodge2(width = 1), aes (label = `Médicos`), vjust = 0.5, hjust = -0.5)
                        

grafico_orientacion
```


## Establezo el IC alfa de 95% y calculo z score para sacar IC95 de proporciones
```{r}
## Establezco CI alpha level (1-alpha/2)*100%
alpha = 0.05

## Calculo z score
z = qnorm(1-alpha/2)

## p_hat = proporción
## CI 95 de proporciones esta dado por p_hat +/- z * sqrt(p_hat * (1-p_hat)/n)
```


## Proporcion de pacientes con sii

```{r}
## factorizo la proporcion de sii mensual
proporcion_sii_mensual <-"SII mensual"

encuesta[proporcion_sii_mensual] <- lapply(encuesta[proporcion], factor, levels = c("0 a 25%", "25 a 50%", "> de 50%"), ordered = T)


## proporcion de consultas mensuales

proporcion_sii_general<- encuesta %>%
        group_by(`SII mensual`)%>%
        summarise(n = n()) %>%
        mutate(Proporcion = round((n/sum(n))*100,1),
               media = round(mean(n),1),
               mediana = round(median(n),1),
               ds = round(sqrt(var(Proporcion)),1),
            IC95min = round((Proporcion/100 - z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1),
            IC95max = round((Proporcion/100 + z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1)) %>%
                        ungroup()

proporcion_sii<- encuesta %>%
        group_by(Edad_ordinal, `Orientación dicotómica`, `SII mensual`)%>%
        summarise(n = n()) %>%
        mutate(Proporcion = round((n/sum(n))*100,1),
               media = round(mean(n),1),
               mediana = round(median(n),1),
               ds = round(sqrt(var(Proporcion)),1),
            IC95min = round((Proporcion/100 - z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1),
            IC95max = round((Proporcion/100 + z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1)) %>%
                        ungroup()



ggplot(proporcion_sii, aes(fill = `SII mensual`, y = Proporcion,  x = `Orientación dicotómica`)) +
        geom_col(position = "dodge") + 
        theme(axis.text.x=element_blank()) +
        geom_text(position = position_dodge2(width = 1), aes (label = `Proporcion`), vjust = -0.5) +
                   facet_wrap(~Edad_ordinal, scales="free", ncol = 2) +
        labs(title = "Proporción de consultas mensuales por SII", x = "Especialidad", y = "% de profesionales", fill = "Consultas mensuales") +
        scale_x_discrete(labels = c("Neurogastro", "No neurogastro","Neurogastro", "No neurogastro","Neurogastro", "No neurogastro")) +
        expand_limits (y = c(0, 70))


## calculo intervalo de confiaza para SII mensual
## no sé si no es dife

prop.test(56, 304, p = NULL, conf.level = 0.95, correct = T)
prop.test(147, 304, p = NULL, conf.level = 0.95, correct = T)
prop.test(101, 304, p = NULL, conf.level = 0.95, correct = T)

```

## Proporción de consultas por sii segun edad

```{r}
## proporcion de consultas por edad
proporcion_sii_edad <- encuesta %>%
        group_by(Edad_ordinal,`SII mensual`)%>%
        summarise(n = n()) %>%
        mutate(Proporcion = round((n/sum(n))*100,1),
               media = round(mean(n),1),
               mediana = round(median(n),1),
               ds = round(sqrt(var(Proporcion)),1),
            IC95min = round((Proporcion/100 - z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1),
            IC95max = round((Proporcion/100 + z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1)) %>%
                        ungroup()

## grafico facetado por edad
ggplot(proporcion_sii_edad, aes(fill = `SII mensual`, y = Proporcion,  x = Edad_ordinal)) +
        geom_col(position = "dodge") + 
        theme(axis.text.x=element_blank()) +
        geom_text(position = position_dodge2(width = 1), aes (label = `Proporcion`), vjust = -0.5) +
        geom_errorbar(aes(ymin = IC95min, ymax = IC95max), position = position_dodge(0.9), width = 0.2) +
                   facet_wrap(~Edad_ordinal, scales="free", ncol = 2) +
        labs(title = "Proporción de consultas mensuales por SII", x = "Proporción de consultas mensuales", y = "% de profesionales", fill = "Consultas mensuales") +
        expand_limits (y = c(0, 70))


```

# Chi cuadrado de consultas sii por edad
```{r}

## Creo una tabla con las variables a comparar
tabla_sii_edad <- xtabs(Proporcion ~ `SII mensual` + Edad_ordinal, proporcion_sii_edad)

tabla_sii_edad

## Aplico chisq por fila (por eso el 1, si fuera por columna sería el 2)
chi_sii_edad <- apply(tabla_sii_edad, 1, chisq.test)
## pido que me tire el valor de p
sapply(chi_sii_edad, "[", "p.value")


```

## Proporción de consultas por orientación


```{r}

proporcion_sii_orientacion <- encuesta %>%
        group_by(`Orientación dicotómica`, `SII mensual`)%>%
        summarise(n = n()) %>%
        mutate(Proporcion = round((n/sum(n))*100,1),
               media = round(mean(n),1),
               mediana = round(median(n),1),
               ds = round(sqrt(var(Proporcion)),1),
            IC95min = round((Proporcion/100 - z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1),
            IC95max = round((Proporcion/100 + z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1)) %>%
                        ungroup()

ggplot(proporcion_sii_orientacion, aes(fill = `SII mensual`, y = Proporcion,  x = `Orientación dicotómica`)) +
        geom_col(position = "dodge") + 
        theme(axis.text.x=element_blank()) +
        geom_text(position = position_dodge2(width = 1), aes (label = `Proporcion`), vjust = -0.5) +
        geom_errorbar(aes(ymin = IC95min, ymax = IC95max), position = position_dodge(0.9), width = 0.2) +
                   facet_wrap(~Edad_ordinal, scales="free", ncol = 2) +
        facet_wrap(~`Orientación dicotómica`, scales="free", ncol = 2) +
        labs(title = "Proporción de consultas mensuales por SII", x = "Especialidad", y = "% de profesionales", fill = "Consultas mensuales") +
        expand_limits (y = c(0, 70))

summary(proporcion_sii_edad)

```

# Chi cuadrado de consultas sii por orientacion
```{r}
## Creo una tabla con las variables a comparar
tabla_sii_orientacion <- xtabs(Proporcion ~ `SII mensual` + `Orientación dicotómica`, proporcion_sii_orientacion)

tabla_sii_orientacion

## Aplico chisq por fila (por eso el 1, si fuera por columna sería el 2)
chi_sii_orientacion <- apply(tabla_sii_orientacion, 1, chisq.test)
## pido que me tire el valor de p
sapply(chi_sii_orientacion, "[", "p.value")

```


## analizo fisiopatología de la variante diarrea y la variante constipación
Para esto acorto el valor medicamentos y limpio las observaciones de los tratamientos (tienen por error 2 opciones en algunas observaciones)

grafico la fisiopatologia

```{r}

fisiopato_diarrea <- encuesta %>%
         group_by(`Fisiopatología más frecuente variante diarrea`) %>%
                        summarise(n = n()) %>%
                        mutate(Proporcion = round((n/sum(n))*100,1),
                               media = round(mean(n),1),
                               mediana = round(median(n),1),
                               ds = round(sqrt(var(Proporcion)),1),
             IC95min = round((Proporcion/100 - z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1),
            IC95max = round((Proporcion/100 + z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1)) %>%
                        ungroup()


grafico_fisiopato_diarrea <- ggplot(fisiopato_diarrea, aes(x= `Fisiopatología más frecuente variante diarrea`, y = Proporcion, fill = Proporcion)) +
                        geom_col(na.rm = T, show.legend = FALSE) + 
                        scale_x_discrete(na.translate = FALSE) +
                        theme_bw() +
                        coord_flip() +
        labs(title = "Fisiopatología más frecuente de la variante diarrea", x = "Fisiopatología", y = "Porcentaje de respuestas")

grafico_fisiopato_diarrea

fisiopato_constipacion <- encuesta %>%
         group_by(`Fisiopatología más frecuente variante constipación`) %>%
                        summarise(n = n()) %>%
                         mutate(Proporcion = round((n/sum(n))*100,1),
                               media = round(mean(n),1),
                               mediana = round(median(n),1),
                               ds = round(sqrt(var(Proporcion)),1),
             IC95min = round((Proporcion/100 - z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1),
            IC95max = round((Proporcion/100 + z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1)) %>%
                        ungroup()

grafico_fisiopato_constipacion <- ggplot(fisiopato_constipacion, aes(x= `Fisiopatología más frecuente variante constipación`, y = Proporcion, fill = Proporcion)) +
                        geom_col(na.rm = T, show.legend = FALSE) + 
                        scale_x_discrete(na.translate = FALSE) +
                        theme_bw() +
                        coord_flip() +
        labs(title = "Fisiopatología más frecuente de la variante constipación", x = "Fisiopatología", y = "Porcentaje de respuestas")


grafico_fisiopato_constipacion               
```

## proporciones e IC95 con sus respectivas p de la fisiopatologia de SII-D y SII-C 

```{r}

##proporciones diarrea total
prop.test(30, 303, p = NULL, conf.level = 0.95, correct = T)
prop.test(82, 303, p = NULL, conf.level = 0.95, correct = T)
prop.test(13, 303, p = NULL, conf.level = 0.95, correct = T)
prop.test(150, 303, p = NULL, conf.level = 0.95, correct = T)

## proporciones diarrea dico
prop.test(5, 53, p = NULL, conf.level = 0.95, correct = T)
prop.test(23, 53, p = NULL, conf.level = 0.95, correct = T)
prop.test(4, 53, p = NULL, conf.level = 0.95, correct = T)
prop.test(16, 53, p = NULL, conf.level = 0.95, correct = T)
prop.test(134, 250, p = NULL, conf.level = 0.95, correct = T)
prop.test(59, 250, p = NULL, conf.level = 0.95, correct = T)
prop.test(25, 250, p = NULL, conf.level = 0.95, correct = T)
prop.test(20, 250, p = NULL, conf.level = 0.95, correct = T)
prop.test(9, 250, p = NULL, conf.level = 0.95, correct = T)
prop.test(3, 250, p = NULL, conf.level = 0.95, correct = T)

## proporciones constipacion total
prop.test(130, 303, p = NULL, conf.level = 0.95, correct = T)
prop.test(20, 303, p = NULL, conf.level = 0.95, correct = T)
prop.test(113, 303, p = NULL, conf.level = 0.95, correct = T)
prop.test(36, 303, p = NULL, conf.level = 0.95, correct = T)
prop.test(1, 303, p = NULL, conf.level = 0.95, correct = T)



prop.test(39, 304, p = NULL, conf.level = 0.95, correct = T)
```


## Grafico la fisiopatologia de la diarrea de acuerdo a la especialidad
## Luego de calcular chi cuadrado más abajo, vuelvo sobre el gráfico y marco con * las diferencias significativas
```{r}
fisiopato_diarrea_especialidad <- encuesta %>%
         group_by(`Orientación dicotómica`,`Fisiopatología más frecuente variante diarrea`) %>%
                        summarise(n = n()) %>%
                        mutate(Proporcion = round((n/sum(n))*100,1),
                               media = round(mean(n),1),
                               mediana = round(median(n),1),
                               ds = round(sqrt(var(Proporcion)),1),
             IC95min = round((Proporcion/100 - z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1),
            IC95max = round((Proporcion/100 + z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1)) %>%
                        ungroup()

grafico_fisiopato_diarrea_especialidad <- ggplot(fisiopato_diarrea_especialidad, aes(x= `Fisiopatología más frecuente variante diarrea`, y = Proporcion, fill = `Orientación dicotómica`)) +
                        geom_col(na.rm = T, show.legend = T, position = "dodge") + 
        geom_errorbar(aes(ymin = IC95min, ymax = IC95max), position = position_dodge(0.9), width = 0.2) +
        annotate("text", x = c(2, 6), y = c(50,65), label = "**") +
        geom_text(position = position_dodge(width = 1), aes (label = `Proporcion`), vjust = 1.2, hjust = -0.1) +
                        scale_x_discrete(na.translate = FALSE) +
                        theme_bw() +
                        coord_flip() +
        labs(title = "Fisiopatología más frecuente del SII-D", x = "", y = "Proporción", fill = "Orientación") +
        expand_limits(y = c(0, 50))


grafico_fisiopato_diarrea_especialidad

```


# Chi cuadrado de neurogastro vs no neurogastro de acuerdo a la fisiopatologia de la variante diarrea. 
```{r}

## Creo una tabla de diarrea con las variables a comparar
tabla_diarrea <- xtabs(Proporcion ~ factor(`Fisiopatología más frecuente variante diarrea`) + factor(`Orientación dicotómica`), fisiopato_diarrea_especialidad)

tabla_diarrea

## Aplico chisq por fila (por eso el 1, si fuera por columna sería el 2)
chi_diarrea <- apply(tabla_diarrea, 1, chisq.test)
## pido que me tire el valor de p
sapply(chi_diarrea, "[", "p.value")


```

## Grafico la fisiopatologia de la constipacion de acuerdo a la especialidad
## Luego de calcular chi cuadrado más abajo, vuelvo sobre el gráfico y marco con * las diferencias significativas
```{r}

fisiopato_constipacion_especialidad <- encuesta %>%
         group_by(`Orientación dicotómica`,`Fisiopatología más frecuente variante constipación`) %>%
                        summarise(n = n()) %>%
                        mutate(Proporcion = round((n/sum(n))*100,1),
                               media = round(mean(n),1),
                               mediana = round(median(n),1),
                               ds = round(sqrt(var(Proporcion)),1),
            IC95min = round((Proporcion/100 - z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1),
            IC95max = round((Proporcion/100 + z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1)) %>%
                        ungroup()


grafico_fisiopato_constipacion_especialidad <- ggplot(fisiopato_constipacion_especialidad, aes(x= `Fisiopatología más frecuente variante constipación`, y = Proporcion, fill = `Orientación dicotómica`)) +
                        geom_col(na.rm = T, show.legend = T, position = "dodge") + 
        geom_errorbar(aes(ymin = IC95min, ymax = IC95max), position = position_dodge(0.9), width = 0.2) +
        geom_text(position = position_dodge(width = 1), aes (label = `Proporcion`), vjust = 1.2, hjust = -0.1) +
                annotate("text", x = c(2, 3, 4), y = c(20, 50, 30), label = c("**", "**", "*")) +
                        scale_x_discrete(na.translate = FALSE) +
                        theme_bw() +
                        coord_flip() +
        labs(title = "Fisiopatología más frecuente del SII-C", x = "", y = "Proporción", fill = "Orientación") +
        expand_limits(y = c(0, 50))

grafico_fisiopato_constipacion_especialidad   

```

# Chi cuadrado de neurogastro vs no neurogastro de acuerdo a la fisiopatologia de la constipación
```{r}

## Creo una tabla de constipación con las variables a comparar
tabla_constipacion <- xtabs(Proporcion ~ factor(`Fisiopatología más frecuente variante constipación`) + factor(`Orientación dicotómica`), fisiopato_constipacion_especialidad)

tabla_constipacion

## Aplico chisq por fila (por eso el 1, si fuera por columna sería el 2)
chi_constipacion <- apply(tabla_constipacion, 1, chisq.test)
## pido que me tire el valor de p
sapply(chi_constipacion, "[", "p.value")

```

## Metas del tratamiento general

```{r}
metas <- encuesta %>%
                group_by(`Meta principal endel tratamiento del SII`) %>%
                summarise(n = n()) %>%
                        na.omit()%>%
                        mutate(Proporcion = round((n/sum(n))*100,1),
                               media = round(mean(n),1),
                               mediana = round(median(n),1),
                               ds = round(sqrt(var(Proporcion)),1),
            IC95min = round((Proporcion/100 - z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1),
            IC95max = round((Proporcion/100 + z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1)) %>%
                        ungroup()

prop.test(271, 303, p = NULL, conf.level = 0.95, correct = T)
prop.test(32, 303, p = NULL, conf.level = 0.95, correct = T)

```

## Metas en el tratamiento por edad

```{r}

edad_metas <- encuesta %>%
                        group_by(Edad_ordinal, `Meta principal endel tratamiento del SII`) %>%
                        summarise(n = n()) %>%
                        na.omit()%>%
                        mutate(Proporcion = round((n/sum(n))*100,1),
                               media = round(mean(n),1),
                               mediana = round(median(n),1),
                               ds = round(sqrt(var(Proporcion)),1),
            IC95min = round((Proporcion/100 - z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1),
            IC95max = round((Proporcion/100 + z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1)) %>%
                        ungroup()


## grafico con proporciones

ggplot(edad_metas, aes(x=Edad_ordinal, y = Proporcion, fill = `Meta principal endel tratamiento del SII`)) +
        geom_col(position = "dodge") +
        geom_text(position = position_dodge2(width = 1), aes (label = `Proporcion`), vjust = -0.5) +
        geom_errorbar(aes(ymin = IC95min, ymax = IC95max), position = position_dodge(0.9), width = 0.2) +
        labs(title = "Metas del tratamiento del SII en funcion de la edad", x = "Edad", y = "Proporción", fill = "Meta principal") +
        expand_limits(y = c(0, 95)) +
        scale_fill_manual(values = c("aquamarine3", "darkorchid3"))


## grafico con proporciones con frecuencias entre parentesis

ggplot(edad_metas, aes(x=Edad_ordinal, y = Proporcion, fill = `Meta principal endel tratamiento del SII`)) +
        geom_col(position = "dodge") +
        geom_text(position = position_dodge2(width = 1), aes (label = paste(`Proporcion`,"(", n,")")), vjust = -0.5) +
       labs(title = "Metas del tratamiento del SII en funcion de la edad", x = "Edad", y = "Proporción", fill = "Meta principal") +
        expand_limits(y = c(0, 95)) +
        scale_fill_manual(values = c("aquamarine3", "darkorchid3"))
```


# Chi cuadrado de metas en relación a la edad
```{r}

## Creo una tabla de constipación con las variables a comparar
tabla_edad_metas <- xtabs(Proporcion ~ factor(`Meta principal endel tratamiento del SII`) + Edad_ordinal, edad_metas)

tabla_edad_metas

## Aplico chisq por fila (por eso el 1, si fuera por columna sería el 2)
chi_edad_metas<- apply(tabla_edad_metas, 1, chisq.test)
## pido que me tire el valor de p
sapply(chi_edad_metas, "[", "p.value")

```

## Metas en el tratamiento por especialidad

```{r}

especialidad_metas <- encuesta %>%
                        group_by(`Orientación dicotómica`, `Meta principal endel tratamiento del SII`) %>%
                        summarise(n = n()) %>%
                        na.omit()%>%
                        mutate(Proporcion = round((n/sum(n))*100,1),
                               media = round(mean(n),1),
                               mediana = round(median(n),1),
                               ds = round(sqrt(var(Proporcion)),1),
            IC95min = round((Proporcion/100 - z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1),
            IC95max = round((Proporcion/100 + z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1)) %>%
                        ungroup()

especialidad_metas
```

# Chi cuadrado de metas en relación a la especialidad
```{r}

## Creo una tabla de constipación con las variables a comparar
tabla_especialidad_metas <- xtabs(Proporcion ~ factor(`Meta principal endel tratamiento del SII`) + `Orientación dicotómica`, especialidad_metas)

tabla_especialidad_metas

## Aplico chisq por fila (por eso el 1, si fuera por columna sería el 2)
chi_especialidad_metas<- apply(tabla_especialidad_metas, 1, chisq.test)
## pido que me tire el valor de p
sapply(chi_especialidad_metas, "[", "p.value")

```


## Resultados tratamiento dicotomizado "efectivo" vs "no efectivo"
## Creo una tabla 1

```{r}

library(reshape2)

##selecciono las columnas que me interesan
efectividad_tto_diarrea <- encuesta[,c(18:32,75)]

## les agrego una columna de ID que me va a permitir mapear valores y cambiarlos por otros (efectiva y no efectiva)
efectividad_tto_diarrea$ID <- seq.int(nrow(efectividad_tto_diarrea))

efectividad_tto_diarrea_reshape = 
        dcast(mutate(melt(efectividad_tto_diarrea,id.var="ID"),
      value=plyr::mapvalues(
           value, c("efectiva","algo efectiva","muy efectiva", "no efectiva", "no se"),c("efectiva","efectiva","efectiva","no efectiva","no efectiva"))
   ),ID~variable)


## creo una tabla 1


tabla_tto_diarrea <- table1( ~Loperamida + `Carbón` + Bismuto + Rifaximina + `Otros antibióticos` + `Probióticos` + Trimebutina + `Trimebutina/simeticona` + `Alverina/simeticona` +  Pinaverio + Otilonio + Colestiramina + Amitriptilina + `Antiespasmódicos` + Dieta | `Orientación dicotómica`, data=efectividad_tto_diarrea_reshape, overall= F, render.continuous=my.render.cont, render.categorical=my.render.cat, extra.col=list(`P-valor`=pvalue))


tabla_tto_diarrea

```


## Diarrea: Hago 2 dfs separando neurogastros de no neuro con %(frecuencia)

```{r}
tto_diarrea_neurogastro<- encuesta[,c(18:32,75)] %>%
        filter(`Orientación dicotómica` == "Neurogastro") %>%
        pivot_longer(cols = everything()) %>%
          count(name, value) %>%
  pivot_wider(names_from = value, values_from = n, values_fill = 0) %>%
        mutate("efectiva" = `algo efectiva` + `muy efectiva`)  %>%
        select(c(`name`,`efectiva`, `no efectiva`)) %>%
        arrange(desc(`efectiva`)) %>%
          adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 1) %>%
  adorn_ns()


tto_diarrea_otros <- encuesta[,c(18:32,75)] %>%
        filter(`Orientación dicotómica` != "Neurogastro") %>%
        pivot_longer(cols = everything()) %>%
          count(name, value) %>%
  pivot_wider(names_from = value, values_from = n, values_fill = 0) %>%
        mutate("efectiva" = `algo efectiva` + `muy efectiva`) %>%
        select(c(`name`,`efectiva`, `no efectiva`)) %>%
        arrange(desc(`efectiva`)) %>%
          adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 1) %>%
  adorn_ns() 

tto_diarrea_neurogastro
tto_diarrea_otros


## Junto los 2 dfs de diarrea en uno solo por nombre de medicamento
df_tto_diarrea <- left_join(tto_diarrea_neurogastro,tto_diarrea_otros, by = "name") 


## elimino la ultima fila
df_tto_diarrea <- df_tto_diarrea[-(16),]


# remuevo "en diarrea" y renombro las columnas
colnames(df_tto_diarrea)[1] <- ""
colnames(df_tto_diarrea)[2] <- "Efectiva"
colnames(df_tto_diarrea)[3] <- "No efectiva"
colnames(df_tto_diarrea)[4] <- "Efectiva"
colnames(df_tto_diarrea)[5] <- "No efectiva"


##Creo output de tabla

tabla_final_diarrea <- df_tto_diarrea %>%
          kable(caption = 'Efectividad considerada para diversos tratamientos del SII-D') %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
   kable_classic(full_width = F, html_font = "Arial")

tabla_final_diarrea
```

## exporto la tabla como excel para hacer las modificaciones que no me salen

```{r}
library("writexl")

write_xlsx(df_tto,"C:/Users/Ale/Desktop/Encuesta SII soifer/tabla final diarrea.xlsx")


```

## Ordeno en el excel y pongo los IC con prop.test
```{r}
## ver como hacerlo en el de constipacion

```


## Resultados tratamiento dicotomizado "efectivo" vs "no efectivo"
## Creo una tabla 1


```{r}
library(reshape2)

##selecciono las columnas que me interesan
efectividad_tto_constipacion <- encuesta[,c(33:43,75)]

## les agrego una columna de ID que me va a permitir mapear valores y cambiarlos por otros (efectiva y no efectiva)
efectividad_tto_constipacion$ID <- seq.int(nrow(efectividad_tto_constipacion))

efectividad_tto_constipacion_reshape = 
        dcast(mutate(melt(efectividad_tto_constipacion,id.var="ID"),
      value=plyr::mapvalues(
           value, c("efectiva","algo efectiva","muy efectiva", "no efectiva", "no se"),c("efectiva","efectiva","efectiva","no efectiva","no efectiva"))
   ),ID~variable)

## elimino la palabra constipacion del nombre de la columna
colnames(efectividad_tto_constipacion_reshape)[8] <- "Trimebutina"
colnames(efectividad_tto_constipacion_reshape)[10] <- "Antibióticos"
colnames(efectividad_tto_constipacion_reshape)[12] <- "Dieta"


## creo una tabla 1
tabla_tto_constipacion <- table1( ~ Polietilenglicol + Psyllium + Lactulosa + Linaclotida + Prucalopride + `Sales biliares` +  Trimebutina + `Bisacodilo/picosulfato` + `Antibióticos` + `Senósidos` + Dieta | `Orientación dicotómica`, data=efectividad_tto_constipacion_reshape, overall= F, render.continuous=my.render.cont, render.categorical=my.render.cat, extra.col=list(`P-valor`=pvalue))


tabla_tto_constipacion
```


## Constipacion: ## Hago 2 dfs separando neurogastros de no neuro con %(frecuencia)

```{r}
tto_constipacion_neurogastro<- encuesta[,c(33:43,75)] %>%
        filter(`Orientación dicotómica` == "Neurogastro") %>%
        pivot_longer(cols = everything()) %>%
          count(value, name) %>%
  pivot_wider(names_from = value, values_from = n, values_fill = 0) %>%
        mutate("efectiva" = `algo efectiva` + `muy efectiva`) %>%
        select(c(`name`,`efectiva`, `no efectiva`)) %>%
         arrange(desc(`efectiva`)) %>%
          adorn_percentages("row")%>%
  adorn_pct_formatting(digits = 1) %>%
  adorn_ns() 

        

tto_constipacion_otros <- encuesta[,c(33:43, 75)] %>%
        filter(`Orientación dicotómica` != "Neurogastro") %>%
        pivot_longer(cols = everything()) %>%
          count(name, value) %>%
  pivot_wider(names_from = value, values_from = n, values_fill = 0) %>%
        mutate("efectiva" = `algo efectiva` + `muy efectiva`) %>%
        select(c(`name`,`efectiva`, `no efectiva`)) %>%
         arrange(desc(`efectiva`)) %>%
          adorn_percentages("row")%>%
  adorn_pct_formatting(digits = 1) %>%
  adorn_ns()


## Junto los 2 dfs de diarrea en uno solo por nombre de medicamento
df_tto_constipacion <- left_join(tto_constipacion_neurogastro,tto_constipacion_otros, by = "name") 


## elimino la ultima fila
df_tto_constipacion <- df_tto_constipacion[-(12),]


# remuevo "constipacion" y renombro las columnas
df_tto_constipacion$name <- str_remove(df_tto_constipacion$name, "constipacion")
colnames(df_tto_constipacion)[1] <- ""
colnames(df_tto_constipacion)[2] <- "Efectiva"
colnames(df_tto_constipacion)[3] <- "No efectiva"
colnames(df_tto_constipacion)[4] <- "Efectiva"
colnames(df_tto_constipacion)[5] <- "No efectiva"


##Creo output de tabla

tabla_final_constipacion <- df_tto_constipacion %>%
          kable(caption = 'Efectividad considerada para diversos tratamientos del SII-C') %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
   kable_classic(full_width = F, html_font = "Arial")

tabla_final_constipacion




```


## constipacion: exporto la tabla como excel para hacer las modificaciones que no me salen

```{r}
library("writexl")

write_xlsx(df_tto_constipacion,"C:/Users/Ale/Desktop/Encuesta SII soifer/tto constipacion.xlsx")


```

## Ordeno en el excel y pongo los IC con prop.test
```{r}

dfr_cn <- data.frame(k=c(53,49,48,47,45,42,33,31,27,24),n=rep(53,10))
Map(prop.test,x=dfr_cn$k,n=dfr_cn$n)

dfr_co <- data.frame(k=c(241, 223, 231, 219, 204, 142, 174, 90, 101, 99, 102),n=rep(251,11))
Map(prop.test,x=dfr_co$k,n=dfr_co$n)



```



## Calculo la variante con menos alternativas terapeuticas

```{r}
variante_terapeutica <- encuesta %>%
        group_by(`Variantes con menos alternativas terapéuticas`)%>%
        summarise(n = n()) %>%
        mutate(Proporcion = round((n/sum(n))*100,1),
               media = round(mean(n),1),
               mediana = round(median(n),1),
               ds = round(sqrt(var(Proporcion)),1),
            IC95min = round((Proporcion/100 - z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1),
            IC95max = round((Proporcion/100 + z*sqrt(Proporcion/100 * (1-Proporcion/100)/n))*100,1)) %>%
                        ungroup()

variante_terapeutica

dfr_variante <- data.frame(k=c(185, 87, 43, 49),n=rep(304,4))
Map(prop.test,x=dfr_variante$k,n=dfr_variante$n)

```


## Analizo terapias alternativas
```{r}

## creo df con las variables
terapias_alt <- encuesta[,c(44:46,75)]


## separo las respuestas multiples y hago dummies, luego sumo las columnas que son lo mismo con diferente nombre selecciono las que me interesan
terapias_alt <- mtabulate(strsplit(terapias_alt$`Utiliza terapias alternativas en el SII`, ";")) %>%
        mutate(Deporte = `Actividad física` + `Actividad fisica` + `Actividad física ` + `Actividad física moderada` + `Actividad física o que cause placer` + `Deporte, actividad recreativa (alguna que le dé satisfacción)` + Ejercicio + `Ejercicio ` + `Ejercicio aerobico` + `ejercicio físico` + `Ejercicio Físico` + `ejercicio físico acorde a edad y posibilidades` + `Practicar deportes o tarea s manuales o recreativas` + `Dieta balanceada y ejercicios físicos`,
               Biodecodificacion = Biodecodificacion + `Biodescodificación`, 
               Dieta = `Dieta balanceada y ejercicios físicos` + `Hierbas medicinales`) %>%
        select(c(Deporte, Acupuntura, `Apoyo psicológico`, `Ayurvédica`, Biodecodificacion, `Cambio de estilo de vida`, Dieta, `Hipnoterápia`, `Homeopatía`, Mindfulness, `Meditación`, Yoga))

## creo una lista con la especialidad dicotomizada y la pego al df
lista_orient <- encuesta[,75]

terapias_alt_dic <- cbind(terapias_alt,lista_orient)

## creo una tabla 1 para sacar proporciones y significancia de las diferencias entre especialistas
tabla_alt <- table1( ~factor(Deporte) + factor(Acupuntura) + factor(`Apoyo psicológico`)+ factor(`Ayurvédica`) + factor(Biodecodificacion) + factor(`Cambio de estilo de vida`) + factor(Dieta) + factor(`Hipnoterápia`) + factor(`Homeopatía`) + factor(Mindfulness) + factor(`Meditación`) + factor(Yoga)| lista_orient, data= terapias_alt_dic, overall=F, render.missing=NULL, render.continuous=my.render.cont, render.categorical=my.render.cat, extra.col=list(`P-valor`=pvalue))

tabla_alt


## calculo IC95
prop.test(283,304)
prop.test(115,304)
prop.test(93,304)
prop.test(21,304)
```

## Analizo el inicio del tratamiento con y sin medicacion

```{r}
inicio_tto <- encuesta [,c(44-75)] %>%
        group_by(`Orientación dicotómica`,`¿Considera primero evitar medicación y emplear dieta y productos naturales?`) %>%
       summarise(n = n()) %>%
        mutate(Proporcion = round((n/sum(n))*100,1))

inicio_tto

prop.test(198,302)
```


## Analizo el uso de antidepresivos

```{r}
antidepresivos <- encuesta [,c(45-75)] %>%
        group_by(`Orientación dicotómica`,`Indicación de antidepresivos`) %>%
       summarise(n = n()) %>%
        mutate(Proporcion = round((n/sum(n))*100,1))

antidepresivos

prop.test(160,302)
prop.test(126,302)
prop.test(16,302)

## Creo una tabla de constipación con las variables a comparar
tabla_antidepresivos<- xtabs(Proporcion ~ `Indicación de antidepresivos` + `Orientación dicotómica`, antidepresivos)

tabla_antidepresivos

## Aplico chisq por fila (por eso el 1, si fuera por columna sería el 2)
chi_antidepresivos<- apply(tabla_antidepresivos, 1, chisq.test)
## pido que me tire el valor de p
sapply(chi_antidepresivos, "[", "p.value")

```

```


















## Grafico lugar de trabajo


```{r}
unique(encuesta$`Lugar de Trabajo`)

tabla_trabajo <- mtabulate(strsplit(encuesta$`Lugar de Trabajo`, " y ")) %>%
                         summarise_all(.funs = sum,na.rm=T) 

tabla_trabajo$`Centro medico` <- tabla_trabajo$`Céntro médico` + tabla_trabajo$`centro médico privado` + tabla_trabajo$`Centro médico privado`

tabla_trabajo$`Consultorio privado` <- tabla_trabajo$`Consultorio privado` + tabla_trabajo$`consultorio médico privado` + tabla_trabajo$`consultorio privado`

tabla_trabajo <- subset(tabla_trabajo, select = c(`Consultorio privado`, `Centro medico`, `Hospital`)) %>%
                        pivot_longer(cols = 1:3, names_to = "Centro", values_to = "Médicos")


grafico_orientacion <- ggplot(tabla_trabajo,
                             aes (x= `Centro`, y = `Médicos`, fill = `Centro`)) +
                         geom_col() + 
                scale_fill_brewer(palette = "Pastel1")+ 
        expand_limits(y = c(0, 230)) +
                 labs (title = "Tipo de centro de salud") +
        geom_text(position = position_dodge2(width = 1), aes (label = `Médicos`), vjust = -0.5)
        
                        

grafico_orientacion

```


## Asociación entre criterio diagnóstico y dolor

```{r}
chisq.test(encuesta$`Criterio diagnóstico SII`, encuesta$`¿Existe SII sin dolor?`)

diagnostico_dolor <- encuesta %>%
                        group_by(`Criterio diagnóstico SII`, `¿Existe SII sin dolor?`) %>%
                        summarise(n = n()) %>%
                        mutate(Proporcion = round((n/sum(n))*100,1)) %>%
                        ungroup()

                       
diagnostico_dolor[1:3, 1] <- "Experiencia personal"
diagnostico_dolor[4:6, 1] <- "Criterios de Roma"


str(diagnostico_dolor)

as.factor(c(diagnostico_dolor$`¿Existe SII sin dolor?`, diagnostico_dolor$`Criterio diagnóstico SII`))


ggplot(diagnostico_dolor, aes(x=`Criterio diagnóstico SII`, y = Proporcion, fill = `¿Existe SII sin dolor?`)) +
        geom_col(position = "dodge") +
       theme_bw()

ggplot(diagnostico_dolor, aes(x=`Criterio diagnóstico SII`, y = Proporcion, fill = `¿Existe SII sin dolor?`)) +
        geom_col(position = "dodge") +
        geom_text(position = position_dodge2(width = 1), aes (label = `Proporcion`), vjust = -0.5) +
       labs(title = "Existencia de SII sin dolor según el criterio utilizado para el diagnóstico", subtitle = "X-squared = 15.617, p-value = 0.0004063", x = "Criterio diagnóstico utilizado", y = "Porcentaje de respuesta") +
        expand_limits(y = c(0, 60))
        

```



## Analisis multivariado

```{r}

encuesta_filtrada <- encuesta %>%
        filter


library(survey)

diseno <- svydesign(data = encuesta, repweights = NULL)

analisis_multivar <- svyglm(encuesta~ Edad + factor(Genero) + factor('Región de residencia') + factor('Orientación dicotomica') + factor('Lugar de Trabajo'), design=diseno)
```




## Efectividad rifaximina en funcion de edad

```{r}

efectividad_rifa <- encuesta[,c(33:43,81)] %>%
        group_by()
```
















































## Esfera psi: meta principal del tto

```{r}
unique(encuesta$`Meta principal endel tratamiento del SII`)

meta_tto_edad <- encuesta %>%
        group_by(Edad_ordinal, `Meta principal endel tratamiento del SII`)%>%
         summarise(n = n()) %>%
        na.omit()%>%
        mutate(Proporcion = round((n/sum(n))*100,1))


ggplot(meta_tto_edad, aes(fill = `Meta principal endel tratamiento del SII`, y = Proporcion,  x = Edad_ordinal)) +
        geom_col(position = "dodge") +
        geom_text(position = position_dodge(width = 1), aes (label = `Proporcion`), vjust = -0.5) +
        labs(title = "Meta del tratamiento por edad", subtitle = "X-squared = 4.0575, df = 2, p-value = 0.1315", x = "Edad", y = "Proporción") +
        scale_y_continuous(labels = function(x) paste0(x, "%"))

chisq.test(encuesta$Edad_ordinal, encuesta$`Meta principal endel tratamiento del SII`)

kruskal.test(`Meta principal endel tratamiento del SII` ~ n, data=meta_tto_edad) 

meta_tto_genero <- encuesta %>%
        group_by(Genero, `Meta principal endel tratamiento del SII`)%>%
         summarise(n = n()) %>%
        na.omit()%>%
        mutate(Proporcion = round((n/sum(n))*100,1))

ggplot(meta_tto_genero, aes(fill = `Meta principal endel tratamiento del SII`, y = Proporcion,  x = Genero)) +
        geom_col(position = "dodge") +
          geom_text(position = position_dodge(width = 1), aes (label = `Proporcion`), vjust = -0.5) +
        labs(title = "Meta del tratamiento por género", subtitle = "X-squared = 0.51543, df = 1, p-value = 0.4728", x = "Género", y = "Proporción") +
        scale_y_continuous(labels = function(x) paste0(x, "%"))


chisq.test(encuesta$Genero, encuesta$`Meta principal endel tratamiento del SII`)
kruskal.test(`Meta principal endel tratamiento del SII` ~ n, data=meta_tto_genero) 

```


## Esfera psi: nivel de frustacion

```{r}

frustracion <-"Nivel de frustración"
encuesta[frustracion] <- lapply(encuesta[frustracion], factor, levels = c("Nada", "Un poco", "Mucho"), ordered = T)

frustracion_edad <- encuesta %>%
        group_by(Edad_ordinal, `Nivel de frustración`)%>%
        summarise(n = n()) %>%
        na.omit()%>%
        mutate(Proporcion = round((n/sum(n))*100,1))

chisq.test(encuesta$Edad_ordinal, encuesta$`Nivel de frustración`)

##prop.trend.test(frustracion_edad_pivot)


ggplot(frustracion_edad, aes(fill = `Nivel de frustración`, y = Proporcion,  x = Edad_ordinal)) +
        geom_col(position = "dodge") +
        geom_text(position = position_dodge(width = 1), aes (label = `Proporcion`), vjust = -0.5) +
        labs(title = "Nivel de frustración si el paciente no mejora en 2-3 consultas según edad", subtitle = "X-squared = 9.6931, df = 4, p-value = 0.04593", x = "Edad", y = "Proporción") +
        scale_y_continuous(labels = function(x) paste0(x, "%"))


frustracion_genero <- encuesta %>%
        group_by(Genero, `Nivel de frustración`)%>%
        summarise(n = n()) %>%
        na.omit()%>%
        mutate(Proporcion = round((n/sum(n))*100,1))

chisq.test(encuesta$Genero, encuesta$`Nivel de frustración`)


ggplot(frustracion_genero, aes(fill = `Nivel de frustración`, y = Proporcion,  x = Genero)) +
        geom_col(position = "dodge") +
        geom_text(position = position_dodge(width = 1), aes (label = `Proporcion`), vjust = -0.5) +
        labs(title = "Nivel de frustración si el paciente no mejora en 2-3 consultas según edad", subtitle = "X-squared = 13.164, df = 2, p-value = 0.001385", x = "Género", y = "Proporción") +
        scale_y_continuous(labels = function(x) paste0(x, "%"))

frustracion_genero_dico <- encuesta %>%
       mutate(`Nivel de frustración` = case_when(`Nivel de frustración` %in% "Nada" ~ "No frustrado", 
                                                  `Nivel de frustración` %in% "Un poco" | `Nivel de frustración` %in% "Mucho" ~"Frustrado"))%>%
        group_by(Genero, `Nivel de frustración`)%>%
        summarise(n = n()) %>%
        na.omit()%>%
        mutate(Proporcion = round((n/sum(n))*100,1))
        

frustracion_genero_pivot <- frustracion_genero_dico%>%
        select(-Proporcion) %>%
        pivot_wider(names_from = `Nivel de frustración`, values_from = n)



## como crear una tabla desde el df

tabla_genero_pivot <- type.convert(frustracion_genero_pivot,as.is = TRUE)
        
tabla <- `dimnames<-`(
  as.table(as.matrix(frustracion_genero_pivot[-1])),
  list(Genero = frustracion_genero_pivot$Genero, Frustrado = c("si", "No"))
)

fisher.test(frustracion_genero_pivot [,-1])
fisher.test(tabla)
chisq.test(tabla)

ggplot(frustracion_genero_dico, aes(fill = `Nivel de frustración`, y = Proporcion,  x = Genero)) +
        geom_col(position = "dodge") +
        geom_text(position = position_dodge(width = 1), aes (label = `Proporcion`), vjust = -0.5) +
        labs(title = "Nivel de frustración si el paciente no mejora en 2-3 consultas según edad", subtitle = "X-squared = 0.087772, df = 1, p-value = 0.767", x = "Género", y = "Proporción") +
        scale_y_continuous(labels = function(x) paste0(x, "%"))

cumsum(frustracion_genero_dico$n)
```


## Esfera psi: tratamiento y género


```{r}

names(encuesta)

complejidad_genero_edad<- encuesta %>%
        group_by(Edad_ordinal, `Tratamiento más complejo en género`)%>%
        summarise(n = n()) %>%
        na.omit()%>%
        mutate(Proporcion = round((n/sum(n))*100,1)) %>%
        ungroup

chisq.test(encuesta$Edad_ordinal, encuesta$`Tratamiento más complejo en género`)

ggplot(complejidad_genero_edad, aes(fill = `Tratamiento más complejo en género`, y = Proporcion,  x = Edad_ordinal)) +
        geom_col(position = "dodge") +
        geom_text(position = position_dodge(width = 1), aes (label = `Proporcion`), vjust = -0.5) +
        labs(title = "Complejidad de tratamiento por género de acuerdo a la edad ", subtitle = "X-squared = 5.6363, df = 4, p-value = 0.228", x = "Edad", y = "Proporción") +
        scale_y_continuous(labels = function(x) paste0(x, "%"))


complejidad_genero_genero<- encuesta %>%
        group_by(Genero, `Tratamiento más complejo en género`)%>%
        summarise(n = n()) %>%
        na.omit()%>%
        mutate(Proporcion = round((n/sum(n))*100,1)) %>%
        ungroup

chisq.test(encuesta$Genero, encuesta$`Tratamiento más complejo en género`)

ggplot(complejidad_genero_genero, aes(fill = `Tratamiento más complejo en género`, y = Proporcion,  x = Genero)) +
        geom_col(position = "dodge") +
        geom_text(position = position_dodge(width = 1), aes (label = `Proporcion`), vjust = -0.5) +
        labs(title = "Complejidad de tratamiento por género de acuerdo al género del médico", subtitle = "X-squared = 1.9091, df = 2, p-value = 0.385", x = "Género", y = "Proporción") +
        scale_y_continuous(labels = function(x) paste0(x, "%"))


## veo si hay diferencias entre hombre mujer, excluyendo los que no econtraron diferencias

tabla_genero_tto <- table(x = encuesta$Genero, y = encuesta$`Tratamiento más complejo en género`)

tabla_genero_tto <- tabla[,-3]

chisq.test(tabla_genero_tto)
```
